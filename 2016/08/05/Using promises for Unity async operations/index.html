<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="游戏开发,Promise,Unity3D," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="本文翻译自Using promises for Unity async operations，by Ashley Davis
你是否很难理解如何在Unity中使用promises? 本文将通过例子阐述，如何用promises表示Unity的通用异步操作
之前我写过使用promise进行游戏开发。那篇文章涉及到使用promise的背景、理论及优势，并笼统的介绍如何应用promise进行游戏开发。
本">
<meta property="og:type" content="article">
<meta property="og:title" content="promise应用于Unity异步操作">
<meta property="og:url" content="https://xldcode.github.io/2016/08/05/Using promises for Unity async operations/index.html">
<meta property="og:site_name" content="Sheldon的世界">
<meta property="og:description" content="本文翻译自Using promises for Unity async operations，by Ashley Davis
你是否很难理解如何在Unity中使用promises? 本文将通过例子阐述，如何用promises表示Unity的通用异步操作
之前我写过使用promise进行游戏开发。那篇文章涉及到使用promise的背景、理论及优势，并笼统的介绍如何应用promise进行游戏开发。
本">
<meta property="og:updated_time" content="2016-08-06T04:13:37.588Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="promise应用于Unity异步操作">
<meta name="twitter:description" content="本文翻译自Using promises for Unity async operations，by Ashley Davis
你是否很难理解如何在Unity中使用promises? 本文将通过例子阐述，如何用promises表示Unity的通用异步操作
之前我写过使用promise进行游戏开发。那篇文章涉及到使用promise的背景、理论及优势，并笼统的介绍如何应用promise进行游戏开发。
本">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6315530727228179000,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="https://xldcode.github.io/2016/08/05/Using promises for Unity async operations/"/>

  <title> promise应用于Unity异步操作 | Sheldon的世界 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1412a888cebf708ae1b93afc2321a625";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Sheldon的世界</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Keep Calm and Carry On</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                promise应用于Unity异步操作
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-05T16:37:06-04:00" content="2016-08-05">
              2016-08-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index">
                    <span itemprop="name">翻译</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/05/Using promises for Unity async operations/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/05/Using promises for Unity async operations/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文翻译自<a href="http://www.what-could-possibly-go-wrong.com/using-promises-for-unity-async-operations/" target="_blank" rel="external">Using promises for Unity async operations</a>，by <a href="http://www.what-could-possibly-go-wrong.com/author/ash/" target="_blank" rel="external">Ashley Davis</a></p>
<p>你是否很难理解如何在Unity中使用<a href="https://en.wikipedia.org/wiki/Futures_and_promises" target="_blank" rel="external">promises</a>? 本文将通过例子阐述，如何用promises表示Unity的通用异步操作</p>
<p>之前我写过<a href="http://www.what-could-possibly-go-wrong.com/promises-for-game-development/" target="_blank" rel="external">使用promise进行游戏开发</a>。那篇文章涉及到使用promise的背景、理论及优势，并笼统的介绍如何应用promise进行游戏开发。</p>
<p>本文中，我将降一些档次并提供简单而实用的unity使用promise的例子。</p>
<p>讲例子前，先快速复习下Unity的基本异步操作。然后将通过例子实现。最后再融入一些更复杂的例子来展示promise的强大威力——组合链式异步操作。</p>
<p>本文的Unity例程代码也可在<a href="https://github.com/Real-Serious-Games/Unity-Async-and-Promises" target="_blank" rel="external">github</a>上找到。</p>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>Unity版本 5.3.4f1， 例子也可用之前的版本运行。</p>
<p>代码编辑器使用 Visual Studio2015 社区版</p>
<h3 id="为何使用异步操作"><a href="#为何使用异步操作" class="headerlink" title="为何使用异步操作"></a>为何使用异步操作</h3><p>抛出第一个问题：为何使用异步操作呢？</p>
<p>在许多情形下，并不真正使用异步操作。Unity提供了同步和异步的方式来载入场景及资源，因此我们需要进行取舍。</p>
<p>通常，使用异步编程是为了防止阻塞主线程。举个例子来说，当你采用同步方式加载场景时，整个游戏将会停止刷新及渲染！这会将游戏挂起并不接受任何响应，并将一直持续到同步操作完成。由此可见，用户体验并不是很好，没准还会被认为游戏有BUG！</p>
<p>当你使用异步操作进行加载场景时（有一定延迟），游戏依旧可以进行操作。这意味着在载入的同时，你可以展示动态载入界面或其他游戏功能。</p>
<p>采用流内容的<a href="https://en.wikipedia.org/wiki/Open_world" target="_blank" rel="external">开放世界游戏</a>依赖异步操作。它并不希望在玩家在游戏世界中移动时，因为载入地形数据而导致游戏挂起。</p>
<h3 id="介绍Unity异步操作"><a href="#介绍Unity异步操作" class="headerlink" title="介绍Unity异步操作"></a>介绍Unity异步操作</h3><p>Unity的异步操作通过Unity coroutines实现，尽管偶尔也通过<a href="http://gameprogrammingpatterns.com/update-method.html" target="_blank" rel="external">update function</a>推送载入完成状态进行操作</p>
<p>最简单的协程可以总结成这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">using RSG;</div><div class="line"></div><div class="line">public class BasicCoroutine : MonoBehaviour</div><div class="line">&#123;</div><div class="line">    public void StartTheCoroutine(... parameters ...)</div><div class="line">    &#123;</div><div class="line">        StartCoroutine(TheCoroutine(... parameters ...))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IEnumerator TheCoroutine(... parameters ...)</div><div class="line">    &#123;</div><div class="line">        var someAsyncOperation = ... creates the async operation ...</div><div class="line"></div><div class="line">        yield return someAsyncOperation;</div><div class="line"></div><div class="line">        // ... some time later this code will continue to</div><div class="line">        // execute after the async operation has completed ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码做了如下操作：</p>
<ol>
<li>定义一个返回 <em>IEnumerator</em> 的函数，该函数实现协程的主体</li>
<li>调用该函数，同时传结果给 <em>StartCoroutine</em></li>
<li>执行异步操作。通常使用 <em>yield</em> 返回一个 <em>AsyncOperation异步操作</em>对象。</li>
<li>协程将挂起，直到异步操作完成。然后恢复执行后续代码。</li>
</ol>
<p>以上就是异步操作协程的基本模板。现在我们看一下实际点的例子。</p>
<p>该例子展示由Unity的WWW 类进行HTTP GET请求。</p>
<p>该例子简单实用，由<a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank" rel="external">REST API</a> 推送 JSON 数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public class CoroutineWithHttpGet : MonoBehavior</div><div class="line">&#123;</div><div class="line">    private IEnumerator TheCoroutine(string url)</div><div class="line">    &#123;</div><div class="line">        var www = new WWW(url);</div><div class="line">        yield return www;       // Allow the async operation to complete.</div><div class="line"></div><div class="line">        if (! string.IsNullOrEmpty(www.error))&#123;</div><div class="line">            // ... an error occurred, handle it ...</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // successfully got a response via HTTP GET.</div><div class="line"></div><div class="line">        var response  = www.text;</div><div class="line"></div><div class="line">        // ... do something with the response ...</div><div class="line">        // if the data retrived is JSON, you can deserialize it here.</div><div class="line"></div><div class="line">        Debug.Log(response);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过传入REST API的url来启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">StartCoroutine(TheCoroutine(&quot;http://some-host/some-rest-api&quot;));</div></pre></td></tr></table></figure></p>
<p>上例中，”<a href="http://some-host/some-rest-api" target="_blank" rel="external">http://some-host/some-rest-api</a>“ 可以替换成 “<a href="http://www.google.com" target="_blank" rel="external">http://www.google.com</a>“ 等任何合法URL，<br>这样，将看到HTML源码输出到LOG。</p>
<p>目前我还不打算详解协程的工作流程，以后我将写一篇文章来讲解。这样说来，<em>yield</em> 之后的代码将是异步被执行的。</p>
<h3 id="为何使用promise"><a href="#为何使用promise" class="headerlink" title="为何使用promise"></a>为何使用promise</h3><p>本文的核心是如何用promise来表示异步操作和协程。来思考下为什么要这么做吧。</p>
<p>实际上，文章<a href="http://www.what-could-possibly-go-wrong.com/promises-for-game-development/#promisesvsunitycoroutines" target="_blank" rel="external">使用promise进行游戏开发</a>的协程部分已经涉及到了。</p>
<p>可以说，我并不是协程的粉丝，我更倾向使用promise来组织异步操作。尽管协程固有其优势，但是我认为其弊大于利。当使用promise后，你会发现组合复杂的异步链式操作会更加灵活。</p>
<p>但是，协程在某些层次上是必须的！ 因为Unity的异步操作是通过协程实现的（也有其他方式实现，在其他文章中我将讨论线程方式）。因此，这就是本文的由来：协程如何作为promise来使用？</p>
<p>这太容易实现了：</p>
<ul>
<li>简单创建一个promise对象，传入协程中</li>
<li>如果协程成功，<em>resolve</em> promise</li>
<li>否则，<em>reject</em> promise.</li>
</ul>
<h3 id="协程作为promise的例子"><a href="#协程作为promise的例子" class="headerlink" title="协程作为promise的例子"></a>协程作为promise的例子</h3><p>现在移步到协程作为promise的例子。 首先通过一些简单的模板开始，这些模板可以认为是入口。然后用实际的例子——载入场景或资源——来讲解。最后我将展示更复杂的多异步操作链式组合例子。</p>
<h4 id="1-协程作为promise的基本模板"><a href="#1-协程作为promise的基本模板" class="headerlink" title="1. 协程作为promise的基本模板"></a>1. 协程作为promise的基本模板</h4><p>所有例子的关键是如何用简单的协程表示promise. 你可以用此非特化的模板例子，它展示了所有后续例子的基本模式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">using RSG;</div><div class="line"></div><div class="line">public class BasicCoroutineAsPromise : MonoBehavior</div><div class="line">&#123;</div><div class="line">    public IPromise Execute()</div><div class="line">    &#123;</div><div class="line">        // Create Promise object</div><div class="line">        return new Promise((resolve, reject) =&gt;</div><div class="line">            // Pass the promise to the coroutine</div><div class="line">            StartCoroutine(TheCoroutine(resolve, reject))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IEnumerator TheCoroutine(</div><div class="line">        Action resolve,</div><div class="line">        Action&lt;Exception&gt;reject</div><div class="line">    )</div><div class="line">    &#123;</div><div class="line">        // ... add your async operations here ...</div><div class="line">        yield return yourAsyncOperation;</div><div class="line"></div><div class="line">        // ... several yields later ...</div><div class="line"></div><div class="line">        var someErrorOccurred = ... did an error occur ...</div><div class="line"></div><div class="line">        if(someErrorOccurred)&#123;</div><div class="line">            // An error occured, reject the promise</div><div class="line">            reject(someErrorOccured);</div><div class="line">        &#125; else&#123;</div><div class="line">            // completed successfully, resolve the promise</div><div class="line">            resolve();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就是这么简单任性。</p>
<p>这个简单的例子执行了以下步骤：</p>
<ul>
<li><em>Execute</em> 方法调用异步操作</li>
<li>创建了<code>promise</code>对象</li>
<li>Promise的构造函数传入一个匿名函数，它传递了<code>resolve</code>和<code>reject</code>函数。promise通过这些函数同我们交互。</li>
<li>启动协程</li>
<li>依据协程成功与否来调用<em>resolve</em>或<em>reject</em>。</li>
</ul>
<p>现在通过<code>Then</code>和<code>Catch</code>来实现链式回调：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var exampleCoroutine = someGameObject.AddComponment&lt;BasicCoroutineAsPromise&gt;();</div><div class="line"></div><div class="line">exampleCoroutine.Execute()</div><div class="line">    .Then(()=&gt;&#123;</div><div class="line">        // Coroutine completed succesfully and yield a result.</div><div class="line">    &#125;)</div><div class="line">    .Catch(()=&gt;&#123;</div><div class="line">        // Coroutine failed with an error!</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<p><code>Then</code> 当promise resolved后调用</p>
<p><code>Catch</code> 当promise rejected后调用</p>
<h4 id="2-协程完成后获取结果"><a href="#2-协程完成后获取结果" class="headerlink" title="2. 协程完成后获取结果"></a>2. 协程完成后获取结果</h4><p>第一个例子假设我们并不需要协程返回结果。这在实际应用上更为常见。经常的，载入场景或后台处理很多时候并不需要明显的结果，你所要的仅是完成后的回调或错误处理。</p>
<p>另外一些情形，你需要取回一些结果。现在我们通过HTTP请求和载入资源来展示。以上例子处理的最后，你需要一些结果来进一步处理。因此你需要<em>泛型</em>promise来resolve一个特定值。</p>
<p>同样以一个非特化模板开始<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class CoroutineResult : MonoBehaviour</div><div class="line">&#123;</div><div class="line">    public IPromise&lt;string&gt; Execute()</div><div class="line">    &#123;</div><div class="line">        return new Promise&lt;string&gt;((resolve, reject) =&gt;</div><div class="line">            StartCoroutine(TheCoroutine(resolve, reject))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IEnumerator TheCoroutine(</div><div class="line">        Action&lt;string&gt; resolve,</div><div class="line">        Action&lt;Exception&gt; reject</div><div class="line">    )</div><div class="line">    &#123;</div><div class="line">        // ... add your async operations here ...</div><div class="line"></div><div class="line">        yield return yourAsyncOperation;</div><div class="line"></div><div class="line">        // ... several yields later ...</div><div class="line"></div><div class="line">        var someErrorOccurred = ... did an error occur ...</div><div class="line">        if (someErrorOccurred)</div><div class="line">        &#123;</div><div class="line">            // An error occurred, reject the promise.</div><div class="line">            reject(new ApplicationException(&quot;My error&quot;));</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            // Completed successfully,</div><div class="line">            // resolve the promise to return a particular value.</div><div class="line">            resolve(&quot;Hi from the coroutine!&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>简明起见，该例子中promise硬编码resolve一个string值。我们稍后会用真是例子。</p>
<p>以下是调用代码。和之前的很像，只是<code>Then</code> 传递了一个value，它就是promise resolve的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var exampleCoroutine = gameObject.AddComponent&lt;CoroutineResult&gt;();</div><div class="line">exampleCoroutine.Execute()</div><div class="line">    .Then(value =&gt;</div><div class="line">    &#123;</div><div class="line">        Debug.Log(&quot;Coroutine has completed with value: &quot; + value);</div><div class="line">    &#125;)</div><div class="line">    .Catch(ex =&gt;</div><div class="line">    &#123;</div><div class="line">        Debug.LogException(ex, this);</div><div class="line">    &#125;);</div></pre></td></tr></table></figure></p>
<h4 id="3-使用WWW进行Http-GET请求作为promise"><a href="#3-使用WWW进行Http-GET请求作为promise" class="headerlink" title="3. 使用WWW进行Http GET请求作为promise"></a>3. 使用WWW进行Http GET请求作为promise</h4><p>现在该是现实例子的时间了。该例子展示了如何用Unity的WWW类promise化HTTP GET请求。</p>
<p>该例子是之前HTTP GET例子的扩展。它resolved了取回的网页文本内容。内容可能是简单字符串，或是CSV文件，或是JSON数据等等。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public class CoroutineWithHttpGet : MonoBehavior</div><div class="line">&#123;</div><div class="line">    public IPromise&lt;string&gt; Get(string url)</div><div class="line">    &#123;</div><div class="line">        return new Promise&lt;string&gt;((resolve, reject) =&gt;</div><div class="line">            StartCoroutine(TheCoroutine(url, resolve, reject))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IEnumerator TheCoroutine(</div><div class="line">        string url,</div><div class="line">        Action&lt;string&gt; resolve,</div><div class="line">        Action&lt;Exception&gt; reject)</div><div class="line">    &#123;</div><div class="line">        var www = new WWW(url);</div><div class="line">        yield return www;</div><div class="line"></div><div class="line">        if(!string.IsNullOrEmpty(www.error))&#123;</div><div class="line">            reject(new ApplicationException(www.error));</div><div class="line">        &#125; else&#123;</div><div class="line">            resolve(www.text);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上例中，我们假设取回的数据是文本数据。他可以当做简单的二进制数据。这样，我们可以用byte数组或某种buffer对象来表示promise resolve的值。</p>
<p>以下就是简单例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">var exampleCoroutine = gameObject.AddComponment&lt;CoroutineWithHttpGet&gt;();</div><div class="line">exampleCoroutine.Get(&quot;http://www.google.com&quot;)</div><div class="line">    .Then(value =&gt; &#123;</div><div class="line">        Debug.Log(&quot;Html: &quot; + value);</div><div class="line">    &#125;)</div><div class="line">    .Catch(ex =&gt;&#123;</div><div class="line">        Debug.LogException(ex, this);</div><div class="line">    &#125;)</div></pre></td></tr></table></figure></p>
<p>现在，我们增加JSON反序列化。</p>
<p>假设REST API返回了JSON数据。同时让例子更加实际，在游戏云服务器取回的数据是leaderboard。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class Leaderboard</div><div class="line">&#123;</div><div class="line">    // Class defined for deserialization.</div><div class="line">&#125;</div><div class="line"></div><div class="line">exampleCoroutine.Get(&quot;http://the-game-server.com/leaderboard-rest-api&quot;)</div><div class="line">    .Then(jsonData =&gt; JsonConvert.DeserializeObject&lt;Leaderboard&gt;(jsonData))</div><div class="line">    .Then(leaderboard =&gt; ... do something with the leaderboard ...)</div><div class="line">    .Catch(ex =&gt; Debug.Exception(ex, this));</div></pre></td></tr></table></figure></p>
<p>本例中，我使用<a href="http://www.newtonsoft.com/json" target="_blank" rel="external">JSON.NET</a>。你可以使用其他可用于Unity的<a href="https://github.com/codecapers/Unity.Newtonsoft.Json" target="_blank" rel="external">版本</a>。JSON.NET非常棒，但是在Unity下不好用。若是你用Unity5.3以上版本，我更推荐用原生<a href="http://docs.unity3d.com/Manual/JSONSerialization.html" target="_blank" rel="external">JSON API</a>。</p>
<p>你可能没见过promise的链式调用，我希望这将是你喜爱它的契机。如果链式调用过程中发生任何错误，<code>Catch</code>将捕获并处理。这异步异常捕获和常规异常处理非常类似</p>
<h4 id="4-GameObject-MonoBehavior的单例形式"><a href="#4-GameObject-MonoBehavior的单例形式" class="headerlink" title="4. GameObject/MonoBehavior的单例形式"></a>4. GameObject/MonoBehavior的单例形式</h4><p>现在用单例让通用模本更便捷实用。与之前HTTP例子类似，但是惰性初始化单例GameObject对象，直到第一次调用。这样，能够在后续的使用中复用该单例。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class SingletonInstance : MonoBehavior</div><div class="line">&#123;</div><div class="line">    private static SingletonInstance singletonInstance = null;</div><div class="line"></div><div class="line">    public static IPromise&lt;string&gt; Get(string url)</div><div class="line">    &#123;</div><div class="line">        if(singletonInstance == null)&#123;</div><div class="line">            var gameObject = new GameObject(&quot;_HTTP_Helper_&quot;);</div><div class="line">            GameObject.DontDestroyOnLoad(gameObject);</div><div class="line">            singletonInstance = gameObject.AddComponent&lt;SingletonInstance&gt;();</div><div class="line">        &#125;</div><div class="line">        return singletonInstance.PrivateGet(url);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IPromise&lt;string&gt; PrivateGet(string url)</div><div class="line">    &#123;</div><div class="line">        return new Promise&lt;string&gt;((resolve, reject) =&gt;</div><div class="line">            StartCortoutine(TheCoroutine(url, resolve, reject))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ... same before ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意，在<code>Get</code>方程中调用游戏对象和组件的生成。同时调用<code>DontDestroyOnLoad</code>,他保证单例在切换场景后依旧存留在内存中。</p>
<p>可以注意到我们把GameObject的名字以下划线开头，这样在Unity的面板中就能直观看到创建的过程。这意味着我们用肉眼快速分辨哪些对象是手工创建的。</p>
<p>那么，如何使用这个单例呢？通过单例的自动创建，将更简化使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SingletonInstance.Get(&quot;http://www.google.com&quot;)</div><div class="line">    .Then(value =&gt; Debug.Log(value))</div><div class="line">    .Catch(ex =&gt; Debug.ExceptionLog(ex, this));</div></pre></td></tr></table></figure></p>
<p>你可能会说单例模式是一个糟糕的设计模式。正常情况下我同意你的观点。但是基于Unity奇怪的框架架构，单例会简单实用。当APP规模变得更大更复杂后，困难成倍增长。这时，我们需要学习新的技术，例如<a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="external">依赖注入</a>来简化管理。这点我将在未来的文章中讨论。</p>
<p>除了便捷，单例还有什么好处呢？你可能注意到，我们轻微的实现了Unity API的解耦，松耦合几乎等同于更好的代码设计（虽然用到极致也会产生破坏）。我们调用MonoBehavior的静态函数，返回一个promise用于管理异步操作。我们可以将此放在一个非MonoBehavior的类中，实现更好的解耦。未来将使用允许<em>依赖注入</em>的接口。这样，遮蔽了Unity并实现了Unity API的完全解耦。这怎么实现？它为什么这么好用？简单而言，这样更便于移植代码到其他游戏引擎。例如，若是我们完全解耦，代码可能移植到<a href="https://en.wikipedia.org/wiki/MonoGame" target="_blank" rel="external">MonoGame</a>。这里我YY了，我将在以后的文章中讨论这点。</p>
<h4 id="5-异步加载场景"><a href="#5-异步加载场景" class="headerlink" title="5. 异步加载场景"></a>5. 异步加载场景</h4><p>本例中，我将展示作为promise，如何异步载入场景。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public class SceneLoader : MonoBehaviour</div><div class="line">&#123;</div><div class="line">    private static SceneLoader singletonInstance = null;</div><div class="line"></div><div class="line">    /// &lt;summary&gt;</div><div class="line">    /// Load a named scene, returns a promise that is resolved</div><div class="line">    /// when the scene has loaded.</div><div class="line">    /// &lt;/summary&gt;</div><div class="line">    public static IPromise LoadScene(string sceneName)</div><div class="line">    &#123;</div><div class="line">        if (singletonInstance == null)</div><div class="line">        &#123;</div><div class="line">            var gameObject = new GameObject(&quot;_SceneLoader&quot;);</div><div class="line">            GameObject.DontDestroyOnLoad(gameObject);</div><div class="line">            singletonInstance = gameObject.AddComponent&lt;SceneLoader&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return singletonInstance.PrivateLoadScene(sceneName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IPromise PrivateLoadScene(string sceneName)</div><div class="line">    &#123;</div><div class="line">        return new Promise((resolve, reject) =&gt;</div><div class="line">            StartCoroutine(TheCoroutine(sceneName, resolve, reject))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IEnumerator TheCoroutine(</div><div class="line">        string sceneName,</div><div class="line">        Action resolve,</div><div class="line">        Action&lt;Exception&gt; reject</div><div class="line">    )</div><div class="line">    &#123;</div><div class="line">        yield return Application.LoadLevelAsync(sceneName);</div><div class="line"></div><div class="line">        resolve();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以下是调用代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SceneLoader.LoadScene(&quot;Some-Scene&quot;)</div><div class="line">    .Then(() =&gt; Debug.Log(&quot;Loaded scene.&quot;))</div><div class="line">    .Catch(ex =&gt; Debug.LogException(ex, this));</div></pre></td></tr></table></figure></p>
<p>确认你的场景已经添加到 build settings中，否则将会报错。<br>该例中用<code>Application.LoadLevelAsync</code>。同样你也可用例8的<code>LoadLevelAdditiveAsync</code>。</p>
<p>若是使用Unity 5.3，上述函数可能已经被废弃了。你可以使用<code>SceneManager function</code>来实现相同的功能。</p>
<h4 id="6-异步加载bundle"><a href="#6-异步加载bundle" class="headerlink" title="6. 异步加载bundle"></a>6. 异步加载bundle</h4><p>本例展示如何异步载入asset bundle，然后实例化bundle并放入场景中。本例很有意思，因为可以使用promise的链式调用实现实例化后的操作。</p>
<p>首先创建asset bundle。可以依据Unity的文档实现。这里我简化了。</p>
<p>使用Unity Editor标记prefabs包含于bundles中。</p>
<p>在github例子工程中，我已经预制了一些bundle。依据Unity手册，需使用如下代码创建asset bundle。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">using UnityEditor</div><div class="line"></div><div class="line">public class AssetBundleCreator</div><div class="line">&#123;</div><div class="line">    [MenuItem(&quot;Custom/Build Asset Bundles&quot;)]</div><div class="line">    static void BuildAllAssetBundles()</div><div class="line">    &#123;</div><div class="line">        BuildPipeline.BuildAssetBundles(</div><div class="line">            Path.Combine(Application.dataPath, &quot;&lt;sub-directory&gt;&quot;)</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>老实说，难以理解为什么Unity要我们添加额外琐碎的代码来创建asset bundle这么一个重要的功能。他们为什么就不在Unity Editor中默认包含该选项呢。</p>
<p><code>AssetBundleCreator</code>必须保存于 <em>Editor</em>目录下。它只能在编辑模式下使用。</p>
<p>现在看看如何用promise表达加载bundle。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">public class AssetBundleLoader : MonoBehaviour</div><div class="line">&#123;</div><div class="line">    private static AssetBundleLoader singletonInstance = null;</div><div class="line"></div><div class="line">    /// &lt;summary&gt;</div><div class="line">    /// Initiatiates an asynchronous load of an asset bundle.</div><div class="line">    /// Returns a promise that is resolved to the handle of the bundle.</div><div class="line">    /// &lt;/summary&gt;</div><div class="line">    public static IPromise&lt;AssetBundle&gt; LoadAssetBundle(</div><div class="line">        string assetBundleFilePath</div><div class="line">    )</div><div class="line">    &#123;</div><div class="line">        if (singletonInstance == null)</div><div class="line">        &#123;</div><div class="line">            var gameObject = new GameObject(&quot;_AssetBundleLoader&quot;);</div><div class="line">            GameObject.DontDestroyOnLoad(gameObject);</div><div class="line">            singletonInstance =</div><div class="line">                gameObject.AddComponent&lt;AssetBundleLoader&gt;();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return singletonInstance</div><div class="line">            .PrivateLoadAssetBundle(assetBundleFilePath);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IPromise&lt;AssetBundle&gt; PrivateLoadAssetBundle(</div><div class="line">        string assetBundleFilePath</div><div class="line">    )</div><div class="line">    &#123;</div><div class="line">        return new Promise&lt;AssetBundle&gt;((resolve, reject) =&gt;</div><div class="line">            StartCoroutine(TheCoroutine(</div><div class="line">                assetBundleFilePath,</div><div class="line">                resolve,</div><div class="line">                reject</div><div class="line">            ))</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private IEnumerator TheCoroutine(</div><div class="line">        string assetBundleFilePath,</div><div class="line">        Action&lt;AssetBundle&gt; resolve,</div><div class="line">        Action&lt;Exception&gt; reject</div><div class="line">    )</div><div class="line">    &#123;</div><div class="line">        var www = new WWW(&quot;file://&quot; + assetBundleFilePath);</div><div class="line"></div><div class="line">        yield return www;</div><div class="line"></div><div class="line">        if (!string.IsNullOrEmpty(www.error))</div><div class="line">        &#123;</div><div class="line">            var msg = &quot;Failed to load asset bundle &quot; +</div><div class="line">                      assetBundleFilePath + &quot;\r\n&quot; + www.error;</div><div class="line">            reject(new ApplicationException(msg));</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            resolve(www.assetBundle);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着，载入bundle并链式实例化游戏对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">var assetBundleFilePath =</div><div class="line">    Path.Combine(Application.dataPath, &quot;&lt;sub-directory&gt;&quot;);</div><div class="line"></div><div class="line">AssetBundleLoader.LoadAssetBundle(assetBundleFilePath)</div><div class="line">    .Then(assetBundle =&gt;</div><div class="line">    &#123;</div><div class="line">        Debug.Log(&quot;Loaded bundle.&quot;);</div><div class="line"></div><div class="line">        var allBundleObjects = assetBundle</div><div class="line">            // Load all game objects from the bundle.</div><div class="line">            .LoadAllAssets(typeof(GameObject))</div><div class="line"></div><div class="line">            // Cast all objects to the expected type.</div><div class="line">            .Cast&lt;GameObject&gt;();</div><div class="line"></div><div class="line">        var x = 0f;</div><div class="line"></div><div class="line">        // For simplicity let&apos;s just load all objects from the</div><div class="line">        // bundle and place them in a row.</div><div class="line">        foreach (var bundleObject in allBundleObjects)</div><div class="line">        &#123;</div><div class="line">            Instantiate(</div><div class="line">                bundleObject,</div><div class="line">                new Vector3(x, 0f, 0f),</div><div class="line">                Quaternion.identity</div><div class="line">            );</div><div class="line">            x += 3f;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Unload the bundle, keep loads objects in tact.</div><div class="line">        assetBundle.Unload(false);</div><div class="line">    &#125;)</div><div class="line">    .Catch(ex =&gt; Debug.LogException(ex, this));</div></pre></td></tr></table></figure></p>
<p>本例中，我们简单的实例化bundle并放入场景中，这仅是一个人为的例子用于展示该技术。你可以寻到更好的方式来实现。</p>
<p>本例中，bundle在游戏对象实例化后被unloaded，你也可能保留bundle的缓存，用于后续的使用。</p>
<h4 id="7-组合例子"><a href="#7-组合例子" class="headerlink" title="7. 组合例子"></a>7. 组合例子</h4><p>是时候把例子放在一起了，这样你就能更好感受到promise组合异步逻辑的链式威力。</p>
<p>本例中，我重构提取了一些帮助函数方便自由使用。这样能够更直观的看到链式promise,逻辑同时也很清晰，代码易懂同时bug难以隐藏。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">LoadScene()</div><div class="line">    .Then(() =&gt; LoadBundle())</div><div class="line">    .Then(assetBundle =&gt; InstantiateGameObjects(assetBundle))</div><div class="line">    .Then(assetBundle =&gt; assetBundle.Unload(false))</div><div class="line">    .Catch(ex =&gt; Debug.ExceptionLog(ex, this));</div></pre></td></tr></table></figure></p>
<p>具体代码详见<a href="https://github.com/Real-Serious-Games/Unity-Async-and-Promises/blob/master/Assets/7.%20Combined/CombinedExample.cs" target="_blank" rel="external">github</a></p>
<h4 id="8-硬编码实现合并多场景"><a href="#8-硬编码实现合并多场景" class="headerlink" title="8. 硬编码实现合并多场景"></a>8. 硬编码实现合并多场景</h4><p>本例使用附加场景加载合并到多场景，以下是代码最重要的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AdditiveSceneLoader.LoadScene(&quot;MergeScene1&quot;)</div><div class="line">    .Then(() =&gt; AdditiveSceneLoader.LoadScene(&quot;MergeScene2&quot;))</div><div class="line">    .Then(() =&gt; AdditiveSceneLoader.LoadScene(&quot;MergeScene3&quot;))</div><div class="line">    .Catch(ex =&gt; Debug.LogException(ex, this));</div></pre></td></tr></table></figure></p>
<p>同样的，Unity5.3 api和之前的不同，请相应更换。</p>
<h4 id="9-动态实现合并多场景"><a href="#9-动态实现合并多场景" class="headerlink" title="9. 动态实现合并多场景"></a>9. 动态实现合并多场景</h4><p>上例是硬编码实现。若是动态实现将更有用。有许多方式可以实现。</p>
<p>这里，我生成一个列表，然后使用LINQ的<code>Aggregate</code>折叠列表成promise序列。它实现场景一个接一个的载入。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">var scenesToLoad = new string[]</div><div class="line">&#123;</div><div class="line">    &quot;MergeScene1&quot;,</div><div class="line">    &quot;MergeScene2&quot;,</div><div class="line">    &quot;MergeScene3&quot;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">scenesToLoad.Aggregate(</div><div class="line">        Promise.Resolved(),</div><div class="line">        (prevPromise, sceneName) =&gt;</div><div class="line">            prevPromise.Then(() =&gt;</div><div class="line">                AdditiveSceneLoader.LoadScene(sceneName))</div><div class="line">    )</div><div class="line">    .Then(() =&gt; Debug.Log(&quot;Loaded all scenes.&quot;))</div><div class="line">    .Catch(ex =&gt; Debug.LogException(ex, this));</div></pre></td></tr></table></figure></p>
<p>上述代码看上去很吓人哩，这里有个简单易读的方式，它使用了<code>Promise.All</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var scenesToLoad = new string[]</div><div class="line">&#123;</div><div class="line">    &quot;MergeScene1&quot;,</div><div class="line">    &quot;MergeScene2&quot;,</div><div class="line">    &quot;MergeScene3&quot;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Promise.All(</div><div class="line">        scenesToLoad.Select(sceneName =&gt;</div><div class="line">            AdditiveSceneLoader.LoadScene(sceneName)</div><div class="line">        )</div><div class="line">    )</div><div class="line">    .Then(() =&gt; Debug.Log(&quot;Loaded all scenes.&quot;))</div><div class="line">    .Catch(ex =&gt; Debug.LogException(ex, this));</div></pre></td></tr></table></figure></p>
<p>这里，<code>Promise.All</code>中所有的场景载入是同时的，不分先后。如果想按顺序载入它们，还是用LINQ的<code>Aggregate</code>吧。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>这仅是一篇短文介绍如何表示Unity的异步操作为promise的，代码在<a href="https://github.com/Real-Serious-Games/Unity-Async-and-Promises" target="_blank" rel="external">github</a>上。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>图标这么闪，你不点一下吗</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/uploads/wechatpay_qcode.jpg" alt="Sheldon WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/游戏开发/" rel="tag">#游戏开发</a>
          
            <a href="/tags/Promise/" rel="tag">#Promise</a>
          
            <a href="/tags/Unity3D/" rel="tag">#Unity3D</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/05/Promises for Game Development/" rel="next" title="使用Promise进行游戏开发">
                <i class="fa fa-chevron-left"></i> 使用Promise进行游戏开发
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/05/Fluent behavior trees for AI and game-logic/" rel="prev" title="流式行为树用于AI和游戏逻辑">
                流式行为树用于AI和游戏逻辑 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/08/05/Using promises for Unity async operations/"
           data-title="promise应用于Unity异步操作" data-url="https://xldcode.github.io/2016/08/05/Using promises for Unity async operations/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/head.png"
               alt="Sheldon" />
          <p class="site-author-name" itemprop="name">Sheldon</p>
          <p class="site-description motion-element" itemprop="description">Sheldon 的随笔，技术文章分享、翻译及心得体会</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xldcode" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://coolshell.cn/haoel" title="酷壳" target="_blank">酷壳</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#开发环境"><span class="nav-number">1.</span> <span class="nav-text">开发环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为何使用异步操作"><span class="nav-number">2.</span> <span class="nav-text">为何使用异步操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#介绍Unity异步操作"><span class="nav-number">3.</span> <span class="nav-text">介绍Unity异步操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为何使用promise"><span class="nav-number">4.</span> <span class="nav-text">为何使用promise</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#协程作为promise的例子"><span class="nav-number">5.</span> <span class="nav-text">协程作为promise的例子</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-协程作为promise的基本模板"><span class="nav-number">5.1.</span> <span class="nav-text">1. 协程作为promise的基本模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-协程完成后获取结果"><span class="nav-number">5.2.</span> <span class="nav-text">2. 协程完成后获取结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-使用WWW进行Http-GET请求作为promise"><span class="nav-number">5.3.</span> <span class="nav-text">3. 使用WWW进行Http GET请求作为promise</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-GameObject-MonoBehavior的单例形式"><span class="nav-number">5.4.</span> <span class="nav-text">4. GameObject/MonoBehavior的单例形式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-异步加载场景"><span class="nav-number">5.5.</span> <span class="nav-text">5. 异步加载场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-异步加载bundle"><span class="nav-number">5.6.</span> <span class="nav-text">6. 异步加载bundle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-组合例子"><span class="nav-number">5.7.</span> <span class="nav-text">7. 组合例子</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-硬编码实现合并多场景"><span class="nav-number">5.8.</span> <span class="nav-text">8. 硬编码实现合并多场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-动态实现合并多场景"><span class="nav-number">5.9.</span> <span class="nav-text">9. 动态实现合并多场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结论"><span class="nav-number">6.</span> <span class="nav-text">结论</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sheldon</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xldcodecomment"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
